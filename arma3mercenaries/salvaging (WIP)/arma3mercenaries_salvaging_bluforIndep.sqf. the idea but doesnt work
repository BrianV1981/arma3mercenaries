/*
    arma3mercenaries_salvaging_bluforIndep.sqf
    Author: BrianV1981

    Description:
    Allow players to earn credits by salvaging equipment from destroyed enemy vehicles.
    The amount of credits depends on the type of the salvaged vehicle.
*/

// Vehicle type to reward mapping
_salvageValues = [
    // Helicopters
    ["O_Heli_Light_02_F", [8000, 12000]],
    ["O_Heli_Light_02_unarmed_F", [7000, 11000]],
    ["O_Heli_Light_02_v2_F", [8000, 12000]],
    ["O_Heli_Attack_02_F", [20000, 25000]],
    ["O_Heli_Attack_02_black_F", [20000, 25000]],
    ["O_Heli_Transport_04_F", [14000, 18000]],
    ["O_Heli_Transport_04_ammo_F", [15000, 19000]],
    ["O_Heli_Transport_04_bench_F", [13000, 17000]],
    ["O_Heli_Transport_04_box_F", [14000, 18000]],
    ["O_Heli_Transport_04_covered_F", [14000, 18000]],
    ["O_Heli_Transport_04_fuel_F", [15000, 19000]],
    ["O_Heli_Transport_04_medevac_F", [16000, 20000]],
    ["O_Heli_Transport_04_repair_F", [15000, 19000]],
    ["O_Heli_Transport_04_black_F", [14000, 18000]],
    ["O_Heli_Transport_04_ammo_black_F", [15000, 19000]],
    ["O_Heli_Transport_04_bench_black_F", [13000, 17000]],
    ["O_Heli_Transport_04_box_black_F", [14000, 18000]],
    ["O_Heli_Transport_04_covered_black_F", [14000, 18000]],
    ["O_Heli_Transport_04_fuel_black_F", [15000, 19000]],
    ["O_Heli_Transport_04_medevac_black_F", [16000, 20000]],
    ["O_Heli_Transport_04_repair_black_F", [15000, 19000]],
    ["O_Plane_CAS_02_F", [25000, 30000]],
    ["O_Plane_Fighter_02_F", [30000, 35000]],
    ["O_Plane_Fighter_02_Stealth_F", [32000, 37000]],

    // Tanks and APCs
    ["O_APC_Tracked_02_cannon_F", [18000, 22000]],
    ["O_APC_Tracked_02_AA_F", [20000, 24000]],
    ["O_MBT_02_cannon_F", [22000, 26000]],
    ["O_MBT_02_arty_F", [23000, 27000]],
    ["O_APC_Wheeled_02_rcws_F", [16000, 20000]],
    ["O_T_APC_Tracked_02_cannon_ghex_F", [18000, 22000]],
    ["O_T_APC_Tracked_02_AA_ghex_F", [20000, 24000]],
    ["O_T_APC_Wheeled_02_rcws_ghex_F", [16000, 20000]],
    ["O_T_MBT_02_cannon_ghex_F", [22000, 26000]],
    ["O_T_MBT_02_arty_ghex_F", [23000, 27000]],

    // Drones and UGVs
    ["O_UAV_01_F", [4000, 6000]],
    ["O_UAV_02_F", [7000, 9000]],
    ["O_UAV_02_CAS_F", [8000, 10000]],
    ["O_UGV_01_F", [5000, 7000]],
    ["O_UGV_01_rcws_F", [6000, 8000]],
    ["O_T_UGV_01_ghex_F", [5000, 7000]],
    ["O_T_UGV_01_rcws_ghex_F", [6000, 8000]],
    ["O_T_UAV_04_CAS_F", [8000, 10000]],

    // MRAPs and Light Vehicles
    ["O_MRAP_02_F", [10000, 13000]],
    ["O_MRAP_02_hmg_F", [11000, 14000]],
    ["O_MRAP_02_gmg_F", [12000, 15000]],
    ["O_G_Offroad_01_F", [2000, 4000]],
    ["O_G_Offroad_01_armed_F", [5000, 7000]],
    ["O_Quadbike_01_F", [1000, 2000]],
    ["O_G_Quadbike_01_F", [1000, 2000]],
    ["O_Truck_02_covered_F", [8000, 11000]],
    ["O_Truck_02_transport_F", [7500, 10500]],
    ["O_G_Van_01_transport_F", [3000, 5000]],
    ["O_Truck_03_transport_F", [9000, 12000]],
    ["O_Truck_03_covered_F", [9500, 12500]],
    ["O_Truck_03_device_F", [14000, 18000]],
    ["O_T_LSV_02_armed_F", [8000, 12000]],
    ["O_T_LSV_02_armed_viper_F", [9000, 13000]],
    ["O_T_LSV_02_unarmed_F", [7000, 10000]],
    ["O_T_LSV_02_unarmed_viper_F", [8000, 11000]],
    ["O_LSV_02_armed_F", [8000, 12000]],
    ["O_LSV_02_armed_viper_F", [9000, 13000]],
    ["O_LSV_02_unarmed_F", [7000, 10000]],
    ["O_LSV_02_unarmed_viper_F", [8000, 11000]],
    ["O_T_LSV_02_armed_black_F", [8000, 12000]],
    ["O_T_LSV_02_armed_ghex_F", [8000, 12000]],
    ["O_T_LSV_02_armed_arid_F", [8000, 12000]],
    ["O_T_LSV_02_unarmed_black_F", [7000, 10000]],
    ["O_T_LSV_02_unarmed_ghex_F", [7000, 10000]],
    ["O_T_LSV_02_unarmed_arid_F", [7000, 10000]],
    ["O_LSV_02_armed_black_F", [8000, 12000]],
    ["O_LSV_02_armed_ghex_F", [8000, 12000]],
    ["O_LSV_02_armed_arid_F", [8000, 12000]],
    ["O_LSV_02_unarmed_black_F", [7000, 10000]],
    ["O_LSV_02_unarmed_ghex_F", [7000, 10000]],
    ["O_LSV_02_unarmed_arid_F", [7000, 10000]],
    ["O_T_MRAP_02_ghex_F", [10000, 13000]],
    ["O_T_MRAP_02_hmg_ghex_F", [11000, 14000]],
    ["O_T_MRAP_02_gmg_ghex_F", [12000, 15000]],
    ["O_T_Quadbike_01_ghex_F", [1000, 2000]],
    ["O_T_Truck_03_transport_ghex_F", [9000, 12000]],
    ["O_T_Truck_03_covered_ghex_F", [9500, 12500]],
    ["O_T_Truck_03_device_ghex_F", [14000, 18000]],

    // Boats
    ["O_Boat_Armed_01_hmg_F", [7000, 9000]],
    ["O_Boat_Transport_01_F", [3000, 5000]],
    ["O_Lifeboat", [1000, 3000]],
    ["O_G_Boat_Transport_01_F", [3000, 5000]],
    ["O_T_Boat_Armed_01_hmg_F", [7000, 9000]],
    ["O_T_Boat_Transport_01_F", [3000, 5000]],
    ["O_T_Lifeboat", [1000, 3000]],
    ["O_G_Boat_Transport_02_F", [3500, 5500]],
    ["O_SDV_01_F", [4000, 6000]],

    // Repair and Support Vehicles
    ["O_G_Offroad_01_repair_F", [5000, 7000]],
    ["O_Truck_02_box_F", [8000, 10000]],
    ["O_Truck_02_medical_F", [8500, 10500]],
    ["O_Truck_02_Ammo_F", [8000, 10000]],
    ["O_Truck_02_fuel_F", [7500, 9500]],
    ["O_G_Van_01_fuel_F", [3000, 5000]],
    ["O_Truck_03_repair_F", [10000, 13000]],
    ["O_Truck_03_ammo_F", [10000, 13000]],
    ["O_Truck_03_fuel_F", [9500, 11500]],
    ["O_Truck_03_medical_F", [9500, 11500]],
    ["Land_Pod_Heli_Transport_04_bench_F", [6000, 8000]],
    ["Land_Pod_Heli_Transport_04_covered_F", [6000, 8000]],
    ["Land_Pod_Heli_Transport_04_medevac_F", [7000, 9000]],
    ["Land_Pod_Heli_Transport_04_bench_black_F", [6000, 8000]],
    ["Land_Pod_Heli_Transport_04_covered_black_F", [6000, 8000]],
    ["Land_Pod_Heli_Transport_04_medevac_black_F", [7000, 9000]],
    ["O_T_Truck_03_repair_ghex_F", [10000, 13000]],
    ["O_T_Truck_03_ammo_ghex_F", [10000, 13000]],
    ["O_T_Truck_03_fuel_ghex_F", [9500, 11500]],
    ["O_T_Truck_03_medical_ghex_F", [9500, 11500]]
];

// Function to add salvage interaction
private _addSalvageInteraction = {
    params ["_vehicle"];
    if (isNil {_vehicle getVariable "salvageAdded"}) {
        _vehicle setVariable ["salvageAdded", true, true]; // Mark the vehicle to prevent multiple salvaging attempts
        systemChat "Salvage interaction added to vehicle."; // Debug output

        // Check for toolkit and add action if applicable
        [_vehicle, 0, ["ACE_MainActions"], {
            hasToolkit player
        }, {
            // Define what happens when the interaction is used
            _vehicleType = typeOf _vehicle;
            _possibleRewards = _salvageValues select {(_x select 0) == _vehicleType};
            systemChat format ["Salvage interaction initiated on %1.", _vehicleType]; // Debug output

            if (!isNil "_possibleRewards") {
                _rewardRange = _possibleRewards select 0 select 1;
                _credits = selectRandom [_rewardRange select 0, _rewardRange select 1];

                // Display a progress bar for the salvage operation
                ["Salvaging", "Salvaging in progress...", "Please wait...", {
                    [player, _credits] call grad_moneymenu_fnc_addFunds;
                    hint format ["You have salvaged this vehicle and earned %1 credits.", _credits];
                    deleteVehicle _vehicle;  // Delete the wreckage after salvage is complete
                    systemChat format ["Salvage completed. %1 credits added.", _credits]; // Debug output
                }, {}, 60] call ace_common_fnc_progressBar;
            } else {
                systemChat "No reward found for this vehicle type."; // Debug output
            }
        }, {}, [_vehicle], 10, 0, true, false] call ace_interact_menu_fnc_addActionToObject;
    } else {
        systemChat "Salvage already added to this vehicle."; // Debug output
    }
};

// Register an event handler to all vehicles
{
    _x addEventHandler ["Killed", {
        params ["_vehicle", "_killer"];
        [_vehicle] call _addSalvageInteraction;  // Apply the salvage interaction function
        systemChat format ["Killed event triggered for %1.", typeOf _vehicle]; // Debug output
    }];
} forEach vehicles;